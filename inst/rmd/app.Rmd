---
output:
  html_document:
    css: "www/custom.css"
runtime: shiny_prerendered
author: Environmental Cheminformatics Group, LCSB, University of Luxembourg
title: "`r paste('Shinyscreen', packageVersion('shinyscreen'))`"
---

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(system.file(package="shinyscreen","www/shinyscreen2.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:5px;')
```


```{r, context='setup', include='false'}
library(data.table)
library(shinyscreen)
library(ggplot2)
### library(shinydashboard)

init <- readRDS("init.rds")
def_state <- new_state()
def_datafiles <- shinyscreen:::dtable(file=character(0),
                                      tag=character(0))
def_datatab <- shinyscreen:::dtable("tag"=factor(),
                                    "adduct"=factor(levels=shinyscreen:::DISP_ADDUCTS),
                                    "set"=factor())

def_summ_subset <- shinyscreen:::dtable("QA Column"=shinyscreen:::QA_FLAGS,
                                        "Select"=factor("ignore",levels=shinyscreen:::SUBSET_VALS))
### RMassBank masks shiny::validate. Unmask it.
validate <- shiny::validate
### def_state$input$tab$tags <- def_datatab
rv_state <- list2rev(def_state)
compl_sets <- eventReactive(rv_state$input$tab$setid,
                            rv_state$input$tab$setid[,unique(set)])
### Reactive values to support some of the UI elements.
### rv_ui <- reactiveValues(datatab=def_tags)

### Update with data-files.
rv_dfile <- reactiveVal(def_datafiles)

### Data-file table when loading.
rv_datatab <- reactiveVal(def_datatab)

### Re-definitions.
PLOT_FEATURES <- shinyscreen:::PLOT_FEATURES

### Plotting parameters.

### Transient rt range.
rv_rtrange <- reactiveValues(min=def_state$conf$rt_min,
                             max=def_state$conf$rt_max)

### Transient mz range.
rv_mzrange <- reactiveValues(min=NA,
                             max=NA)

projects <- list.dirs(path=init$userdir, full.names = F, recursive = F)
inputdirs <- list.dirs(path=init$indir, full.names = F, recursive = F)

```
<style type="text/css">
.main-container {
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
}
</style>

# {.tabset .tabset-pills}

## Project {.tabset}

<details>
<summary>Projects, input directories and compound lists</summary>

When you start the program with `app` function, you define two
superdirecotories: `userdir` and `indir`. Directory `userdir` contains
all the existing projects and any new projects defined during the
current session will be saved here. Data inside a project directory
consists of intermediate files, saved states and workflow outputs.

To create a new project, type in the name and press the `Create`
button. To load a project, select the project and press `Load`.

There is also a possibility to save the current project state. Just
use the `Save project` button. This action will record all your
settings and selected inputs.

Each `Shinyscreen` project needs input data: mass spectrometry files
(in mzML format), compound and set lists. These should all be present
before starting `Shinyscreen` in one of the directories under
`userdir`.



</details>

### Project management

<!-- ##### Create new project -->

<!-- ```{r, echo=F} -->
<!-- textInput(inputId = "new_proj_name", label= "New project name",value = "") -->
<!-- actionButton(inputId = "create_proj_b", -->
<!--              label= "Create") -->

<!-- ``` -->


#### Load or initialise a project

<details>
<summary>Load, or initialise a project</summary>

All projects are shown in the `Avaliable projects`
list. Load the project by pressing `Select project` button. 

If the project is new, it has to contain the compound list(s) and the
set list.

</details>

```{r, echo=F}
selectInput('proj_list',
            label = "Select project",
            choices = projects)
actionButton(inputId = "load_proj_b",
             label= "Load/Initialise")
textOutput("curr_proj")

```


#### Save project
```{r, echo=F}
actionButton(inputId = "save_proj_b",
             label= "Save project")
```

#### Download project

<details> 
<summary>Download results</summary>

Button `Download project` only makes sense to be used if Shinyscreen is
served over network. If this is the case, clicking this button will
download plots and csvs generated in the project directory.
</details>

```{r, echo=F}
downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
     tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
        class), href = "", target = "_blank", download = NA, 
        icon("download"), label, ...)
 }

downloadButtonRmd("dwn_proj_b",
                  "Download project directory")
```


#### Select data directory
<details>
<summary>More on data directories</summary>

Data directory is a subdirectory of the `indir` directory which is
one of the arguments to `app` function used to start Shinyscreen
GUI. It contains the `mzML` data files.

Select one of the data directories from the list by clicking the
`Select` button.

</details>

```{r, echo=F}
selectInput('indir_list',
            label = "Input directories",
            choices = inputdirs)
actionButton(inputId = "sel_indir_b",
             label= "Select")
textOutput("curr_data_dir")
```

### Compound list inputs

#### Select compound lists

<details><summary>About compound lists</summary>
A compound list is composed of entries describing compounds. This
description is used to search for its spectrum in the data file. The
list is a table in the ***CSV*** format and contains these columns,

* ***ID*** : required column, must be filled; this is a user-defined
  ID, uniquely associated with a compound
  
* ***Name*** : this column can be left blank; if not, it should contain the
  names of the compounds
  
* ***SMILES*** : a _SMILES_ string, describing the structure of the
  compound; this entry can be left empty only if one of either
  ***Formula***, or ***mz*** entries are not
  
* ***Formula*** : a chemical formula of a compound; this field can be
  empty only if one of either ***SMILES***, or ***mz*** entries are
  not
  
* ***mz*** : mass of the ionised compound; this field can be left
  empty only if one of either ***SMILES***, or ***Formula*** is not
  
* ***CAS*** : the CAS number of the compound; it can be left empty

* ***RT*** : retention time of the MS1 peak in minutes, if known; can
  be left empty.
  
Only ***ID*** and one of ***SMILES***, ***Formula*** or ***mz*** must
be filled. When structure, or a formula of a compound is known, it is
also possible to look for various adducts in the sample. Of course,
scanning for completely unknown compounds is also supported by the
***mz*** column. In this case, ***mz*** is the mass of the ion.

It is strongly recommended to quote SMILES, names and formulas in the
CSV file used with Shinyscreen.

Select one, or more compound lists by clicking `Select` button.
</details>

<div style= "display: flex; vertical-align:top; padding-right: 1.0em">

<div>
```{r, echo=FALSE}
selectInput('comp_list',
            label = "Select compound lists",
            multiple = T,
            choices = "")
actionButton(inputId = "comp_list_b",
             label= "Select")

```
</div>

<div>

**Selected compound lists**

```{r, echo=FALSE}
htmlOutput('comp_list_report')
```

</div>

</div>
#### Select set lists

<details><summary>About set lists (_setid_ tables)</summary>
The compound lists can contain more entries than is necessary. Using
the _setid_ lists, it is possible to create _compound sets_ which
contain only those compounds that will actually be searched for in the
data files. A _setid table_ is a _CSV_ containing at least two
columns,

* ***ID*** : the ID entry from the compound list

* ***set*** : an user-defined set name.

Select one set list by clicking `Select` button.
</details>

<div style= "display: flex; vertical-align:top; padding-right: 1em">

<div>

```{r, echo=FALSE}
selectInput('set_list',
            label = "Select set lists",
            multiple = T,
            choices = "")
actionButton(inputId = "set_list_b",
             label= "Select")

```

</div>

<div>

**Selected `setid' list**

```{r, echo=FALSE}
htmlOutput('sets_report')
```

</div>

<div>

### Data files
<details><summary>Load data files</summary>
Shinyscreen currently supports only the **mzML** file format. After
loading the files, set file tags in the file table (column
**tag**). Additionally, specify a set of compounds that is supposed
to be extracted from the file using the **set** column. Finally,
specify the **adduct** in the adduct column. In case of compounds
with unknown structure and formula, the adduct is ignored for obvious
reasons.

Select datafiles of interest from the list and confirm the selection
by clicking `Select`.

</details>
```{r, echo=FALSE}

selectInput('dfile_list',
            label = "Select datafiles",
            multiple = T,
            choices = "")
actionButton(inputId = "datafiles_b",
             label= "Load data files.", width="10%")

```

<details><summary>Assign tags to data files.</summary> 

Each tag designates an unique file. Use the table below to assign
tags.

</details>

```{r, echo=FALSE}
DT::DTOutput("datafiles",width="25%")
actionButton("rem_dfiles_b",label="Remove selected entries",width="10%")
```




<details>

<summary>Assign sets to tags.</summary>

For each tag, assign a set and an adduct (if the structure information
exists, otherwise _adduct_ column is ignored).

</details>

```{r, echo=F}
DT::DTOutput("datatab",width="25%")
```

## Configure, Extract, Prescreen {.tabset}

<details><summary>Extract spectra from data files.</summary>

Spectral extraction is controled by the parameters under the
_Extraction_ tab, while the quality check parameters are located under
the _Prescreening_ tab.

After Shinyscreen is configured, the compound and setid lists loaded,
it is possible to proceed with extracting the data. The extraction
process can start after pressing `Extract`. Depending on the size of
the commpound list and the properties of the data files this may take
a while.

Once the data is extracted, quality checking can be carried out using
the `Prescreen` button.

The parameters affecting current extraction are displayed in the
*Overview* section. 

</details>


<div style= "display: flex; vertical-align:top;">
<div style= "padding-right: 0.5em">
### Extraction

#### Spectra extraction based settings

<details><summary>MS1 coarse error</summary>

Extract all entries matching the target mass within this error in the
precursor table.
</details>
```{r, echo=F}
vu <- get_val_unit(def_state$conf$tolerance[["ms1 coarse"]])
shinyscreen::mz_input(input_mz = "ms1_coarse",
                       input_unit = "ms1_coarse_unit",
                       def_mz = vu[['val']],
                       def_unit = vu[['unit']])
```

<details><summary>MS1 fine error</summary>

The precursor table masses can be of lower accuracy. Once there is a
match within the coarse error, it can be further checked versus the
fine error bounds directly in the mass spectrum.

</details>
```{r, echo=F}
vu <- get_val_unit(def_state$conf$tolerance[["ms1 fine"]])
shinyscreen::mz_input(input_mz = "ms1_fine",
                      input_unit = "ms1_fine_unit",
                      def_mz = vu[['val']],
                      def_unit = vu[['unit']])
```

<details><summary>MS1 EIC window</summary>

The mz interval over which the intensities are aggregated to generate
a chromatogram.

</details>
```{r, echo=F}
vu <- get_val_unit(def_state$conf$tolerance[["eic"]])
shinyscreen::mz_input(input_mz = "ms1_eic",
                      input_unit = "ms1_eic_unit",
                      def_mz = vu[['val']],
                      def_unit = vu[['unit']])
```

<details><summary>Retention time window</summary>

If the expected retention time has been specified for the compound,
then search for the MS1 signature inside the window defined by this
range.

</details>
```{r, echo=F}
vu <- get_val_unit(def_state$conf$tolerance[["rt"]])
shinyscreen::rt_input(input_rt = "ms1_rt_win",
                      input_unit = "ms1_rt_win_unit",
                      def_rt = vu[['val']],
                      def_unit = vu[['unit']])
```

<details><summary>Fill missing precursors</summary>

* **fill** : Try to guess precursors of MS2 entries. This is done by
picking MS1 which chronologically preceeds a given MS2 entry.
* **omit** : Ignore MS2 with missing precursors.
* **do_nothing** : Default. Use MS1--MS2 metadata recorded in the file
to associate MS1 and MS2 entries. Usually works.  
</details>
```{r, echo=F}
radioButtons("missingprec",
             label = "Missing precursors",
             choices = c("do_nothing","fill","omit"),
             selected = "do_nothing")

```

### Prescreening

<details><summary>MS1 intensity threshold</summary>

Ignore MS1 signal below the threshold.

</details>
```{r, echo=F}

numericInput(inputId = "ms1_int_thresh",
             label = NULL,
             value = def_state$conf$prescreen$ms1_int_thresh)
```

<details><summary>MS2 intensity threshold</summary>

Ignore MS2 signal below the threshold.

</details>
```{r, echo=F}

numericInput(inputId = "ms2_int_thresh",
             label = NULL,
             value = def_state$conf$prescreen$ms2_int_thresh)
```


MS1 signal-to-noise ratio.

```{r, echo=F}

numericInput(inputId = "s2n",
             label = NULL,
             value = def_state$conf$prescreen$s2n)
```


<details><summary>MS1/MS2 retention delay.</summary>

Look for associated MS2 spectrum within this window around the MS1
peak.

</details>
```{r, echo=F}
vu <- get_val_unit(def_state$conf$prescreen[["ret_time_shift_tol"]])
shinyscreen::rt_input(input_rt = "ret_time_shift_tol",
                      input_unit = "ret_time_shift_tol_unit",
                      def_rt = vu[['val']],
                      def_unit = vu[['unit']])
```

### Report

<details><summary>Create a report</summary>

Shinyscreen can produce a report containing graps of EICs and spectra
for some or all compounds. The controls below define what enters the
report. Please keep in mind that producing a PDF output with thousands
of compounds will take huge amount of time, so if you are prescreening
a lot of compounds, consider restricting limiting the output to, for
example, those entries that have passed the quality checks.

</details>


<div style= "display: flex; vertical-align:top; padding-right: 0.5em">

<div>

```{r, echo=F}
shiny::textInput(inputId = "rep_aut", label = "Report author", value = def_state$conf$report$author)
shiny::textInput(inputId = "rep_tit", label = "Report title", value = def_state$conf$report$title)
```

</div>


<div>

<details><summary>Filter summary table</summary>

Filter entries in the report according to the QA criteria.

* **qa_pass** : entries that passed all checks

* **qa_ms1_exists** : MS1 intensity is above the MS1 threshold

* **qa_ms2_exists** : those entries for which some MS2 spectra have been found

* **qa_ms1_above_noise** : MS1 is intense enough and above the noise level

* **qa_ms2_good_int** : MS2 intensity is above the MS2 threshold

* **qa_ms2_near** : MS2 spectrum is close enough to the MS1 peak

Values:

* **ignore** : ignore QA criterion
* **take the good ones** : entry passed QA
* **take the bad ones** : entry failed QA

</details>

```{r, echo=F}

DT::DTOutput("summ_subset")

```
</div>

<!-- FIXME: order_summ reordering/editing unstable. Therefore temporarily removed. -->
<!-- <div style="padding-left: 0.5em"> -->

<!-- <details><summary>Ordering by columns</summary> -->
<!-- It is possible to order the summary table using columns (keys):  -->
<!-- *`r paste(gsub("^-(.+)","\\1",shinyscreen:::DEF_INDEX_SUMM), collapse = ',')`*. -->
<!-- The sequence of columns in the table below describes the -->
<!-- sequence of ordering steps -- the key in the first row sorts the -->
<!-- entire summary table and subsequent keys break the ties. -->

<!-- </details> -->

<!-- ```{r, echo=F} -->
<!-- DT::DTOutput("order_summ") -->
<!-- ``` -->

<!-- </div> -->

</div>

</div>

<div style="padding-left: 3em">

#### Control
<div style="display: flex;flex-flow: row wrap;">
```{r, echo=FALSE}
actionButton(inputId = "extract_b",
             label = "Extract")
```

```{r, echo=FALSE}
actionButton(inputId = "presc_b",
             label = "Prescreen")
```
</div>

#### Overview

- Has the data been extracted? `r htmlOutput("is_extracted_stat", inline=T)`
- Has the data been auto-quality checked? `r htmlOutput("is_qa_stat", inline=T)`

##### Extraction

- MS1 coarse: `r htmlOutput("ms1_coarse_stat", inline=T)`
- MS1 fine: `r htmlOutput("ms1_fine_stat", inline=T)`
- MS1 eic: `r htmlOutput("ms1_eic_stat", inline=T)`
- Retention time window: `r htmlOutput("rt_stat", inline=T)`

##### Prescreening

- Intensity Threshold (MS1): `r htmlOutput("ms1_int_thresh_stat", inline=T)`
- Intensity Threshold (MS2): `r htmlOutput("ms2_int_thresh_stat", inline=T)`
- Retention time shift: `r htmlOutput("ret_time_shift_tol_stat", inline=T)`
- Signal-to-noise ratio: `r htmlOutput("s2n_stat", inline=T)`

</div>

</div>

## View compound Lists and Sets

### Compound List

```{r, echo=F}
DT::dataTableOutput("comp_table")
```

### Setid Table
```{r, echo=F}
DT::dataTableOutput("setid_table")
```

## Results Explorer


<div style="display: flex; flex-flow: row nowrap;">
<div style="display: flex; flex-flow: column; padding-right:1.0em">
### Compound Index

<div style="display: flex; flex-flow: row nowrap">
```{r, echo=F}
selectInput("sort1",label="Sort by ", choices=shinyscreen:::ARRANGE_CHOICES,width="15%")
selectInput("sort2",label="then by ", choices=shinyscreen:::ARRANGE_CHOICES,width="15%")
selectInput("sort3",label="then", choices=shinyscreen:::ARRANGE_CHOICES,width="15%")
selectInput("sort4",label="and finally by", choices=shinyscreen:::ARRANGE_CHOICES,width="15%")
```
</div> <!-- Arrange -->

<div>
```{r, echo=F}
DT::DTOutput("cindex")
```

</div> <!-- cindex -->

</div> <!-- Compound Explorer Panel -->

<div style="display: flex-flow: column nowrap">
### Viewer

<div style="display: flex-flow: row nowrap">

<div>
```{r,echo=F}
textOutput("plot_hover_out")
```
</div>
```{r, echo=F}
actionButton("plot_save_single",
             label="Save this plot")
actionButton("plot_save_all",
             label="Save all plots")
actionButton("make_report_b",
             label="Create report")
textInput("plot_ext",
          label = "Plot extension",
          value = "pdf")
## shinyscreen::rt_input(input_rt = "plot_rt_min",
##                       input_unit = "plot_rt_min_unit",
##                       width=15,
##                       width_u=10,
##                       def_rt = "min",
##                       def_unit = "min",
##                       pref = "RT min")
## shinyscreen::rt_input(input_rt = "plot_rt_max",
##                       input_unit = "plot_rt_max_unit",
##                       width=15,
##                       width_u=10,
##                       def_rt = "max",
##                       def_unit = "min",
##                       pref = "RT max")
## hr()
```
</div> <!-- Control Bar -->
</div> <!-- Viewer Panel -->

</div> <!-- Main -->



<!-- ### Compound Index -->

<!-- ```{r, echo=F} -->

<!-- fluidRow(column(h5("Arrange"), -->
<!--                            selectInput("sort1",label="Sort by ", choices=shinyscreen:::ARRANGE_CHOICES), -->
<!--                            selectInput("sort2",label="then by ", choices=shinyscreen:::ARRANGE_CHOICES), -->
<!--                            selectInput("sort3",label="then", choices=shinyscreen:::ARRANGE_CHOICES), -->
<!--                            selectInput("sort4",label="and finally by", choices=shinyscreen:::ARRANGE_CHOICES), -->
<!--                            width = 2), -->
<!--          column(wellPanel(DT::DTOutput("cindex")), -->
<!--                 width = 10)) -->

<!-- ``` -->





<!-- ### Viewer -->

<!-- ```{r, echo=F} -->
<!-- sidebarLayout(sidebarPanel(h5("Pointer position"), -->
<!--                            textOutput("plot_hover_out"), -->
<!--                            textInput("rtrange", -->
<!--                                      label = "Global RT range"), -->
<!--                            shinyscreen::rt_input(input_rt = "plot_rt_min", -->
<!--                                                  input_unit = "plot_rt_min_unit", -->
<!--                                                  width=55, -->
<!--                                                  width_u=40, -->
<!--                                                  def_rt = "min", -->
<!--                                                  def_unit = "min", -->
<!--                                                  pref = "RT min"), -->

<!--                            shinyscreen::rt_input(input_rt = "plot_rt_max", -->
<!--                                                  input_unit = "plot_rt_max_unit", -->
<!--                                                  width=55, -->
<!--                                                  width_u=40, -->
<!--                                                  def_rt = "max", -->
<!--                                                  def_unit = "min", -->
<!--                                                  pref = "RT max"), -->
<!--                            hr(), -->
<!--                            ## Not so important, TODO later. -->
<!--                            ## h5("Log scale"), -->
<!--                            ## checkboxGroupInput("plot_log", -->
<!--                            ##                    label=NULL, -->
<!--                            ##                    choices = c("MS1 EIC","MS2 EIC","MS2 Spectrum"), -->
<!--                            ##                    selected = character(0)), -->
<!--                            ## hr(), -->
<!--                            ## uiOutput("plot_b_ctrl"), -->
<!--                            hr(), -->
<!--                            textInput("plot_ext", -->
<!--                                      label = "Plot extension", -->
<!--                                      value = "pdf"), -->
<!--                            actionButton("plot_save_single", -->
<!--                                         label="Save this plot"), -->
<!--                            actionButton("plot_save_all", -->
<!--                                         label="Save all plots"), -->
<!--                            actionButton("make_report_b", -->
<!--                                         label="Create report"), -->
<!--                            width=4), -->
<!--               wellPanel(id = "tPanel",style = "overflow-y:scroll; max-height:80vh; background: white", -->
<!--                         plotOutput("plot_eic_ms1", -->
<!--                                    hover = hoverOpts(id="plot_hover", -->
<!--                                                      delayType = "throttle", -->
<!--                                                      delay=100), -->
<!--                                    dblclick = "plot_rt_click", -->
<!--                                    brush = "plot_brush"), -->
<!--                         plotOutput("plot_eic_ms2", -->
<!--                                    hover = hoverOpts(id="plot_hover", -->
<!--                                                      delayType = "throttle", -->
<!--                                                      delay=100), -->
<!--                                    dblclick = "plot_rt_click", -->
<!--                                    brush = "plot_brush"), -->
<!--                         plotOutput("plot_ms2_spec", -->
<!--                                    hover = hoverOpts(id="plot_hover", -->
<!--                                                      delayType = "throttle", -->
<!--                                                      delay=100), -->
<!--                                    dblclick = "plot_mz_click", -->
<!--                                    brush = brushOpts(id="plot_mz_brush")) -->
<!--                         ## ,plotOutput("plot_struct") -->
<!--                         )) -->



<!-- ``` -->


<!-- ## Compound Explorer {.tabset} -->

<!-- This is where the prescreening results are presented. The _Browser_ -->
<!-- tab shows a detailed view of the MS2 data as well as the associated -->
<!-- precursors in searchable tables. The _Viewer_ tab shows the -->
<!-- visualisations of the EICs and the plots of the spectra.  Both kinds -->
<!-- of outputs can be exported using portable formats. -->

<!-- Auto quality checks built into Shinyscreen can sometimes yield -->
<!-- unsatisfactory results. In such cases, it is possible to manually -->
<!-- update relevant data. -->

<!-- Please see the respective subsections for more details. -->


<!-- ### Browser -->

<!-- <details><summary>Organise, filter and search through data.</summary> -->

<!-- **Data Organisation** -->

<!-- Postprocessed spectral data is presented in three tables. The first, -->
<!-- always visible, table shows the list of precursors. The entries of this -->
<!-- table are ordered by the following categories in order of -->
<!-- significance: adduct, a data file where they were found, the ion mass -->
<!-- of the precursor and then the retention time. The ordering was chosen -->
<!-- because it will group together isobars. -->

<!-- The second table shows the metadata of all the MS2 entries associated -->
<!-- with the currently selected MS1 entry : the accession number (_an_, a -->
<!-- chronological tag unique to the data file it stems from), the -->
<!-- retention time of the signal (_RT(ms2)_), the intensity (_I(ms2)_), -->
<!-- the collision energy and several quality control flags. -->

<!-- Meaning of QC flags: -->

<!-- - **Selected?** : Is this spectrum the _one_? Auto precscreening will -->
<!--   select the spectral entry that passed all QC checks and is the -->
<!--   closest to the MS1 peak. -->
  
<!-- - **Above threshold?** : Is the MS2 signal greater than the intensity -->
<!--   threshold specified in the _Configuration_ section? -->

<!-- - **MS1/MS2 RT match?** : Is the MS2 within the allowed retention time -->
<!--   window around the MS1 peak? The retention time window can be change -->
<!--   in the _Configuration_ section. -->

<!-- - **MS2 Exists?** : If no MS2 was found for the selected MS1 entry, -->
<!--   this will be unchecked. -->

<!-- If an entry is selected from the MS2 metadata table, its mass spectrum -->
<!-- is going to be shown in the third table. The spectral table is in the -->
<!-- MetFrag-compatible format and can be directly pasted in the spectral -->
<!-- widget on the MetFrag website. Please bear in mind that this method of -->
<!-- spectral matching is for interactive purpouses only, if there are many -->
<!-- spectra that should be processed with MetFrag it is much better to -->
<!-- employ MetFragCL program for batch analysis. Some Shinyscreen support -->
<!-- for this is already there (see _Exporting_). -->


<!-- **Filtering and Searching** -->

<!-- The filters just below the table headers can be used to limit the -->
<!-- displayed data. Numerical columns accept ranges, while the content of -->
<!-- the textual columns will be matched against character strings in the -->
<!-- filters. -->

<!-- </details> -->

<!-- <div style="display: flex; vertical-align: top;margin: auto;"> -->

<!-- <div style="width: 50%;padding-right=1.0em"> -->

<!-- #### Compound selector -->

<!-- ```{r, echo=F} -->
<!-- DT::DTOutput("compound_selector") -->
<!-- ``` -->

<!-- #### MS1 quality check table -->

<!-- ```{r, echo=F} -->
<!-- DT::DTOutput("compound_selector_qa") -->
<!-- ``` -->

<!-- <div id="footer"> -->

<!-- <details><summary>Narrow down entries according to the QA criteria.</summary> -->

<!-- * **qa_pass** : entries that passed all checks -->

<!-- * **qa_ms1_exists** : MS1 intensity is above the MS1 threshold -->

<!-- * **qa_ms2_exists** : those entries for which some MS2 spectra have been found -->

<!-- * **qa_ms1_above_noise** : MS1 is intense enough and above the noise level -->

<!-- * **qa_ms2_good_int** : MS2 intensity is above the MS2 threshold -->

<!-- * **qa_ms2_near** : MS2 spectrum is close enough to the MS1 peak -->

<!-- </details> -->

<!-- ```{r, echo=F} -->
<!-- checkboxGroupInput("cmpd_sel_filter", -->
<!--                    label="Filter Results", -->
<!--                    choices = c(qa_pass="qa_pass", -->
<!--                                qa_ms2_near="qa_ms2_near", -->
<!--                                qa_ms2_good_int="qa_ms2_good_int", -->
<!--                                qa_ms2_exists="qa_ms2_exists", -->
<!--                                qa_ms1_above_noise="qa_ms1_above_noise", -->
<!--                                qa_ms1_exists="qa_ms1_exists"), -->
<!--                    inline=T, -->
<!--                    selected = character(0)) -->

<!-- ``` -->

<!-- </div> -->


<!-- </div> -->



<!-- <div style="width: 50%"> -->



<!-- #### MS2 quality check table -->

<!-- ```{r, echo=F} -->
<!-- DT::DTOutput("compound_ms2_table") -->
<!-- ``` -->



<!-- #### MS2 spectrum -->


<!-- ```{r, echo=F} -->
<!-- DT::DTOutput("compound_ms2_spectrum") -->
<!-- ``` -->

<!-- </div> -->
	
<!-- </div> -->

<!-- <details><summary>Override auto-prescreening results (Commit manual QA).</summary> -->

<!-- After the automatic quality control check based on the criteria -->
<!-- defined in the _Prescreening_ tab is done ,it is possible to manually -->
<!-- update the quality of the retrieved spectra.This can be achieved by -->
<!-- double clicking on the required QA fields namely _MS1/MS2 match?_, -->
<!-- _Above threshold_, _MS2 exists_ after inspecting the peaklist. Once -->
<!-- the manual QA step is done, the changes can be saved by clicking the -->
<!-- _Commit manual QA_ button.  -->

<!-- </details> -->

<!-- ```{r, echo=F} -->
<!-- uiOutput("update_summ_ui") -->
<!-- ``` -->

<!-- <details><summary>Export Data Browser contents.</summary> -->

<!-- A detailed _summary table_ combining all the information from the -->
<!-- _Browser_ tab can be saved in a _CSV_ file by clicking the _Export -->
<!-- MS1/MS2 summary_ tab. The table can be used in combination with -->
<!-- MetFragCL for batch scoring of the entries. -->

<!-- </details> -->
<!-- ```{r, echo=F} -->
<!-- uiOutput("export_summ_ui") -->
<!-- ``` -->


<!-- ### Viewer -->


<!-- <details><summary> Visualize and export the plots. </summary> -->

<!-- For any given ID, the EICs of MS1 and MS2, as well as the -->
<!-- representative mass spectrum (MS2 entry with _Selected?_ checked in -->
<!-- the _Data Browser_) can be visualized by selecting the corresponding -->
<!-- row in the table. The plots can be zoomed-in by selecting the region -->
<!-- of interest using the cursor and double click to zoom-out. It is also -->
<!-- possible to plot mutiple figures by selecting different rows. -->

<!-- Shinyscreen can export the plots in all the formats supported by R -->
<!-- package _ggplot2_ (pdf, png, ...). The plot of the EICs and the mass -->
<!-- spectra will be saved in _figures_ subdirectory of the project -->
<!-- directory. Associated metadata for the plots are saved in _CSV_ files -->
<!-- of the same basename as the plots. The plots themselves feature -->
<!-- minimal legends, so please do create legends more appropriate to your -->
<!-- particular use from the data in the plot _CSV_s. The plots can also be -->
<!-- saved as _ggplot2_ objects by changing the extension to _.rds_. Such a -->
<!-- file can be loaded into R using the `readRDS` function, and then every -->
<!-- visual aspect of the plot can be manually tweaked. This can be useful -->
<!-- when there is a need to comply with specific publication requirements. -->

<!-- Button _Save this plot_ will save the currently selected plot with -->
<!-- currently selected axes ranges and scaling properties. Button _Save -->
<!-- all plots_ will save all the plots with default zoom/axes ranges. -->

<!-- </details> -->

<!-- ```{r, echo=F} -->
<!-- sidebarLayout(sidebarPanel(DT::DTOutput("plot_comp_select"), -->
<!--                            h5("Pointer position"), -->
<!--                            textOutput("plot_hover_out"), -->
<!--                            textInput("rtrange", -->
<!--                                      label = "Global RT range"), -->
<!--                            shinyscreen::rt_input(input_rt = "plot_rt_min", -->
<!--                                                  input_unit = "plot_rt_min_unit", -->
<!--                                                  width=55, -->
<!--                                                  width_u=40, -->
<!--                                                  def_rt = "min", -->
<!--                                                  def_unit = "min", -->
<!--                                                  pref = "RT min"), -->

<!--                            shinyscreen::rt_input(input_rt = "plot_rt_max", -->
<!--                                                  input_unit = "plot_rt_max_unit", -->
<!--                                                  width=55, -->
<!--                                                  width_u=40, -->
<!--                                                  def_rt = "max", -->
<!--                                                  def_unit = "min", -->
<!--                                                  pref = "RT max"), -->
<!--                            hr(), -->
<!--                            ## Not so important, TODO later. -->
<!--                            ## h5("Log scale"), -->
<!--                            ## checkboxGroupInput("plot_log", -->
<!--                            ##                    label=NULL, -->
<!--                            ##                    choices = c("MS1 EIC","MS2 EIC","MS2 Spectrum"), -->
<!--                            ##                    selected = character(0)), -->
<!--                            ## hr(), -->
<!--                            ## uiOutput("plot_b_ctrl"), -->
<!--                            hr(), -->
<!--                            textInput("plot_ext", -->
<!--                                      label = "Plot extension", -->
<!--                                      value = "pdf"), -->
<!--                            actionButton("plot_save_single", -->
<!--                                         label="Save this plot"), -->
<!--                            actionButton("plot_save_all", -->
<!--                                         label="Save all plots"), -->
<!--                            actionButton("make_report_b", -->
<!--                                         label="Create report"), -->
<!--                            width=4), -->
<!--               wellPanel(id = "tPanel",style = "overflow-y:scroll; max-height:80vh; background: white", -->
<!--                         plotOutput("plot_eic", -->
<!--                                    hover = hoverOpts(id="plot_hover", -->
<!--                                                      delayType = "throttle", -->
<!--                                                      delay=100), -->
<!--                                    dblclick = "plot_rt_click", -->
<!--                                    brush = "plot_brush"), -->
<!--                         plotOutput("plot_ms2_spec", -->
<!--                                    hover = hoverOpts(id="plot_hover", -->
<!--                                                      delayType = "throttle", -->
<!--                                                      delay=100), -->
<!--                                    dblclick = "plot_mz_click", -->
<!--                                    brush = brushOpts(id="plot_mz_brush")) -->
<!--                         ## ,plotOutput("plot_struct") -->
<!--                         )) -->



<!-- ``` -->

<!-- ENGINE -->

```{r, echo = F, context = 'setup'}
shinyscreen_server <- shinyscreen:::mk_shinyscreen_server(projects=projects,
                                                          init=init)
```

```{r, echo = F, context = 'server'}
shinyscreen_server(input=input,output=output,session=session)
```
