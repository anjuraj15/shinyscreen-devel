---
output:
  html_document:
    css: "www/custom.css"
runtime: shiny_prerendered
author: Environmental Cheminformatics Group, LCSB, University of Luxembourg
title: "`r paste('Shinyscreen', packageVersion('shinyscreen'))`"
---

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(system.file(package="shinyscreen","www/shinyscreen2.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:5px;')
```


```{r, context='setup', include='false'}
library(data.table)
library(shinyscreen)
library(ggplot2)
### library(shinydashboard)

init <- readRDS("init.rds")
def_state <- new_state()
def_datafiles <- shinyscreen:::dtable(file=character(0),
                                      tag=character(0))
def_datatab <- shinyscreen:::dtable("tag"=factor(),
                                    "adduct"=factor(levels=shinyscreen:::DISP_ADDUCTS),
                                    "set"=factor())

def_summ_subset <- shinyscreen:::dtable("QA Column"=shinyscreen:::QA_FLAGS,
                                        "Select"=factor("ignore",levels=shinyscreen:::SUBSET_VALS))
### RMassBank masks shiny::validate. Unmask it.
validate <- shiny::validate
### def_state$input$tab$tags <- def_datatab
rv_state <- list2rev(def_state)
compl_sets <- eventReactive(rv_state$input$tab$setid,
                            rv_state$input$tab$setid[,unique(set)])
### Reactive values to support some of the UI elements.
### rv_ui <- reactiveValues(datatab=def_tags)

### Update with data-files.
rv_dfile <- reactiveVal(def_datafiles)

### Data-file table when loading.
rv_datatab <- reactiveVal(def_datatab)

### Re-definitions.
PLOT_FEATURES <- shinyscreen:::PLOT_FEATURES

### Plotting parameters.

### Transient rt range.
rv_rtrange <- reactiveValues(min=def_state$conf$rt_min,
                             max=def_state$conf$rt_max)

### Transient mz range.
rv_mzrange <- reactiveValues(min=NA,
                             max=NA)

projects <- list.dirs(path=init$projects, full.names = F, recursive = F)
inputdirs <- list.dirs(path=init$top_data_dir, full.names = F, recursive = F)

```
<style type="text/css">
.main-container {
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
}
</style>

# {.tabset .tabset-pills}

## Project {.tabset}

<details>
<summary>Projects, input directories and compound lists</summary>

When you start the program with `app` function, you define two
superdirectories: `projects` and `top_data_dir`. Directory `projects` contains
all the existing projects and any new projects defined during the
current session will be saved here. Data inside a project directory
consists of intermediate files, saved states and workflow outputs.

To create a new project, type in the name and press the `Create`
button. To load a project, select the project and press `Load`.

There is also a possibility to save the current project state. Just
use the `Save project` button. This action will record all your
settings and selected inputs.

Each `Shinyscreen` project needs input data: mass spectrometry files
(in mzML format), compound and set lists. These should all be present
before starting `Shinyscreen` in one of the directories under
`projects`.



</details>

### Project management

#### Load or initialise a project

<details>
<summary>Load, or initialise a project</summary>

All projects are shown in the `Avaliable projects`
list. Load the project by pressing `Select project` button. 

If the project is new, it has to contain the compound list(s) and the
set list.

</details>

```{r, echo=F}
selectInput('proj_list',
            label = "Select project",
            choices = projects)
actionButton(inputId = "load_proj_b",
             label= "Load/Initialise")
textOutput("curr_proj")

```


#### Save project
```{r, echo=F}
actionButton(inputId = "save_proj_b",
             label= "Save project")
```

#### Download project

<details> 
<summary>Download results</summary>

Button `Download project` only makes sense to be used if Shinyscreen is
served over network. If this is the case, clicking this button will
download plots and csvs generated in the project directory.
</details>

```{r, echo=F}
downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
     tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
        class), href = "", target = "_blank", download = NA, 
        icon("download"), label, ...)
 }

downloadButtonRmd("dwn_proj_b",
                  "Download project directory")
```


#### Select data directory
<details>
<summary>More on data directories</summary>

Data directory is a subdirectory of the `top_data_dir` directory which is
one of the arguments to `app` function used to start Shinyscreen
GUI. It contains the `mzML` data files.

Select one of the data directories from the list by clicking the
`Select` button.

</details>

```{r, echo=F}
selectInput('top_data_dir_list',
            label = "Input directories",
            choices = inputdirs)
actionButton(inputId = "sel_data_dir_b",
             label= "Select")
textOutput("curr_data_dir")
```

### Compound list inputs

#### Select compound lists

<details><summary>About compound lists</summary>
A compound list is composed of entries describing compounds. This
description is used to search for its spectrum in the data file. The
list is a table in the ***CSV*** format and contains these columns,

* ***ID*** : required column, must be filled; this is a user-defined
  ID, uniquely associated with a compound
  
* ***Name*** : this column can be left blank; if not, it should contain the
  names of the compounds
  
* ***SMILES*** : a _SMILES_ string, describing the structure of the
  compound; this entry can be left empty only if one of either
  ***Formula***, or ***mz*** entries are not
  
* ***Formula*** : a chemical formula of a compound; this field can be
  empty only if one of either ***SMILES***, or ***mz*** entries are
  not
  
* ***mz*** : mass of the ionised compound; this field can be left
  empty only if one of either ***SMILES***, or ***Formula*** is not
  
* ***CAS*** : the CAS number of the compound; it can be left empty

* ***RT*** : retention time of the MS1 peak in minutes, if known; can
  be left empty.
  
Only ***ID*** and one of ***SMILES***, ***Formula*** or ***mz*** must
be filled. When structure, or a formula of a compound is known, it is
also possible to look for various adducts in the sample. Of course,
scanning for completely unknown compounds is also supported by the
***mz*** column. In this case, ***mz*** is the mass of the ion.

It is strongly recommended to quote SMILES, names and formulas in the
CSV file used with Shinyscreen.

Select one, or more compound lists by clicking `Select` button.
</details>

<div style= "display: flex; vertical-align:top; padding-right: 1.0em"> <!-- comp-list-box -->

<div> <!-- comp-list-sel -->
```{r, echo=FALSE}
selectInput('comp_list',
            label = "Select compound lists",
            multiple = T,
            choices = "")
actionButton(inputId = "comp_list_b",
             label= "Select")

```
</div> <!-- comp-list-sel -->

<div> <!-- comp-list-disp -->

**Selected compound lists**

```{r, echo=FALSE}
htmlOutput('comp_list_report')
```

</div> <!-- comp-list-disp -->

</div> <!-- comp-list-box -->

#### Select set lists

<details><summary>About set lists (_setid_ tables)</summary>
The compound lists can contain more entries than is necessary. Using
the _setid_ lists, it is possible to create _compound sets_ which
contain only those compounds that will actually be searched for in the
data files. A _setid table_ is a _CSV_ containing at least two
columns,

* ***ID*** : the ID entry from the compound list

* ***set*** : an user-defined set name.

Select one set list by clicking `Select` button.
</details>

<div style= "display: flex; vertical-align:top; padding-right: 1em"> <!-- set-list-box -->

<div> <!-- set-list-sel -->

```{r, echo=FALSE}
selectInput('set_list',
            label = "Select set lists",
            multiple = T,
            choices = "")
actionButton(inputId = "set_list_b",
             label= "Select")

```

</div> <!-- set-list-sel -->

<div> <!-- set-list-rep -->

**Selected `setid' list**

```{r, echo=FALSE}
htmlOutput('sets_report')
```

</div> <!-- set-list-rep -->

</div> <!-- set-list-box -->

### Data files
<details><summary>Load data files</summary>
Shinyscreen currently supports only the **mzML** file format. After
loading the files, set file tags in the file table (column
**tag**). Additionally, specify a set of compounds that is supposed
to be extracted from the file using the **set** column. Finally,
specify the **adduct** in the adduct column. In case of compounds
with unknown structure and formula, the adduct is ignored for obvious
reasons.

Select datafiles of interest from the list and confirm the selection
by clicking `Select`.

</details>
```{r, echo=FALSE}

selectInput('dfile_list',
            label = "Select datafiles",
            multiple = T,
            choices = "")
actionButton(inputId = "datafiles_b",
             label= "Load data files.", width="10%")

```

<details><summary>Assign tags to data files.</summary> 

Each tag designates an unique file. Use the table below to assign
tags.

</details>

```{r, echo=FALSE}
DT::DTOutput("datafiles",width="25%")
actionButton("rem_dfiles_b",label="Remove selected entries",width="10%")
```

<details>

<summary>Assign sets to tags.</summary>

For each tag, assign a set and an adduct (if the structure information
exists, otherwise _adduct_ column is ignored).

</details>

```{r, echo=F}
DT::DTOutput("datatab",width="25%")
```

## Configure, Extract, Prescreen {.tabset}

<div class = "flex-cols"> <!-- confstatus-panes -->
<!-- confstatus-panes-left -->
<div>					
```{r, child='app_config_and_status.Rmd'}
```
</div> <!-- confstatus-panes-left -->
<div>  <!-- confstatus-panes-right -->

#### Control

<div style="display: flex;flex-flow: row wrap;">
```{r, echo=FALSE}
actionButton(inputId = "extract_b",
             label = "Extract")
```

```{r, echo=FALSE}
actionButton(inputId = "presc_b",
             label = "Prescreen")
```
</div>

#### Overview

- Has the data been extracted? `r htmlOutput("is_extracted_stat", inline=T)`
- Has the data been auto-quality checked? `r htmlOutput("is_qa_stat", inline=T)`

##### Extraction

- MS1 coarse: `r htmlOutput("ms1_coarse_stat", inline=T)`
- MS1 fine: `r htmlOutput("ms1_fine_stat", inline=T)`
- MS1 eic: `r htmlOutput("ms1_eic_stat", inline=T)`
- Retention time window: `r htmlOutput("rt_stat", inline=T)`

##### Prescreening

- Intensity Threshold (MS1): `r htmlOutput("ms1_int_thresh_stat", inline=T)`
- Intensity Threshold (MS2): `r htmlOutput("ms2_int_thresh_stat", inline=T)`
- Retention time shift: `r htmlOutput("ret_time_shift_tol_stat", inline=T)`
- Signal-to-noise ratio: `r htmlOutput("s2n_stat", inline=T)`



</div> <!-- confstatus-panes-right -->
</div> <!-- confstatus-panes -->


<!-- TODO: This should be readded at some point. -->
<!-- ```{r, child='app_compound_lists_and_sets.Rmd'} -->
<!-- ``` -->


## Results Explorer


<div style="display: flex; flex-flow: column nowrap;">
<div style="display: flex; flex-flow: column; padding-right:1.0em">

### Compound Index

```{r, echo=F}
selectInput("cindex_group",label="Group",
            choices=c(NA_character_,
                      "adduct","tag"),
            multiple=T,
            selected=c("adduct","tag"))
```
            
<div style="display: flex; flex-flow: row nowrap">
```{r, echo=F}
selectInput("sort1",label="Sort by ", choices=shinyscreen:::ARRANGE_CHOICES,width="15%",selected="quality")
selectInput("sort2",label="then by ", choices=shinyscreen:::ARRANGE_CHOICES,width="15%",selected="mz")
selectInput("sort3",label="then", choices=shinyscreen:::ARRANGE_CHOICES,width="15%")
selectInput("sort4",label="and finally by", choices=shinyscreen:::ARRANGE_CHOICES,width="15%")
```
</div> <!-- Arrange -->

<div>
```{r, echo=F}
DT::DTOutput("cindex")
```

</div> <!-- cindex -->

</div> <!-- Compound Explorer Panel -->

### Viewer

<div class="plot-layout"> <!-- Plot Section -->
<div> 
```{r, echo=F}
plotOutput("plot_eic_ms1",
           hover = hoverOpts(id="plot_hover",
                             delayType = "throttle",
                             delay=100),
           dblclick = "plot_rt_click",
           brush = "plot_brush")
```
</div>
<div>
```{r, echo=F}
plotOutput("plot_struct")
```
</div>
<div>
```{r, echo=F}
plotOutput("plot_eic_ms2",
           hover = hoverOpts(id="plot_hover",
                             delayType = "throttle",
                             delay=100),
           dblclick = "plot_rt_click",
           brush = "plot_brush")
```
</div>
<div> 

#### Tweak Plot Parameters

```{r, echo=F}
textOutput("plot_hover_out")
```

#### Retention Time Range

<div style="display:flex; flex-direction: row;"> <!-- RT div -->
```{r, echo=F}
numericInput(inputId = "plot_rt_min",
             label="Start",
             value=NA_real_,
             width="30%")
```
```{r, echo=F}
numericInput(inputId = "plot_rt_max",
             label="End",
             value=NA_real_,
             width="30%")


```
</div> <!-- RT div -->

#### Intensity Range (MS1)

<div style="display:flex; flex-direction: row;"> <!-- Intensity div -->
```{r, echo=F}
numericInput(inputId = "plot_i_min",
             label="Start",
             value=NA_real_,
             width="30%")
```
```{r, echo=F}
numericInput(inputId = "plot_i_max",
             label="End",
             value=NA_real_,
             width="30%")


```
</div> <!-- Intensity div -->

#### Report

<div style="display: flex-flow: row nowrap"> <!-- Control Bar -->
```{r, echo=F}
textInput("single_plot_fname",
          label="Filename of the single entry plot",
          value="default.pdf")
actionButton("plot_save_single",
             label="Save single entry plot")
textInput("report_name",
          label="Report Name",
          value="report")
actionButton("make_report_b",
             label="Create report")
textInput("summ_name",
          label="Summary table name",
          value="summary.csv")
actionButton("summ_tab_b", "Save summary table")

textInput("ms2_spectra_tab_name",
          label="Table of MS2 spectra",
          value="ms2_spectra_table.csv")
actionButton("ms2_spectra_tab_b", "Save MS2 spectra table")
```

</div> <!-- Control Bar -->

</div>
<div>
```{r, echo=F}
plotOutput("plot_spec_ms2",
           hover = hoverOpts(id="plot_hover",
                             delayType = "throttle",
                             delay=100),
           dblclick = "plot_mz_click",
           brush = brushOpts(id="plot_mz_brush"))
```
</div>
<div></div>
</div> <!-- Plots -->


### Measurement Properties

<div class="measure-prop-sec">

<div class="sel-spec"> <!-- sel-spec -->

#### Select Spectrum

```{r, echo=F}
selectInput("sel_parent_trace",label="Select parent", choices=character(),size=10L,selectize=F)
```

```{r, echo=F}
selectInput("sel_spec",label="Select spectrum", choices=character(),size=10L,selectize=F)
```

```{r, echo=F}
actionButton("cmt_changes_b",label="Commit changes")
```

</div> <!-- sel-spec -->

<div class="measure-props"> <!-- measure-props -->

#### Properties

```{r,echo=F}
numericInput(inputId="chg_ms1_rt",
             label="Retention time (MS1)",
             value=NA_real_)
numericInput(inputId="chg_ms1_int",
             label="Intensity (MS1)",
             value=NA_real_)
```

```{r,echo=F}
checkboxGroupInput(inputId="qabox",
                   label="Quality Control",
                   choices=QABOX_VALS)
```
```{r,echo=F}
checkboxInput(inputId="chg_ms2sel",
              label="MS2 Selected",
              value=F)
```
</div> <!-- measure-props -->

<div class="spec-tab"> <!-- spec tab -->

#### Mass Spectrum

```{r, echo=F}
verbatimTextOutput("print_spec_tab")
```

</div> <!-- spec tab -->

</div> <!-- measure-prop-sec -->

<!-- ENGINE -->

```{r, echo = F, context = 'setup'}
shinyscreen_server <- shinyscreen:::mk_shinyscreen_server(projects=projects,
                                                          init=init)
```

```{r, echo = F, context = 'server'}
shinyscreen_server(input=input,output=output,session=session)
```

